# 車利用管理システム 仕様書

## 1. システム概要

### 1.1 目的

LINEグループ内での車利用時間を管理し、利用状況を記録・集計・レポート化するシステム

### 1.2 システム構成

- **フロントエンド**: LINE Messaging API
- **バックエンド**: Google Apps Script (GAS)
- **データストレージ**: Google SpreadSheet
- **開発環境**: TypeScript + @google/clasp

## 2. 機能仕様

### 2.1 車利用登録機能

#### 2.1.1 概要

LINEグループのメンバーが車利用時間を送信すると、システムが利用予定を確認し、グループに通知する

#### 2.1.2 入力仕様

- **入力形式**: 半角数字（例: 2, 2.5, 0.5）
- **最小値**: 0.1時間以上
- **入力場所**: LINEグループ内

#### 2.1.3 処理仕様

1. ユーザーが車利用時間を送信
2. システムが入力値を検証
3. 現在時刻から利用終了時刻を計算
4. 利用予定メッセージを生成
5. LINEグループに返信
6. 利用記録をスプレッドシートに保存

#### 2.1.4 出力仕様

**返信メッセージ形式**:

```txt
[ユーザー名]さんが
[開始時刻]から
[終了時刻]まで
[利用時間][単位]利用します。
```

**例**:

```txt
jionさんが
01月15日10:00分から
01月15日12:00分まで
2時間利用します。
```

### 2.2 利用記録機能

#### 2.2.1 記録項目

| 項目           | データ型 | 例                  |
| -------------- | -------- | ------------------- |
| 記録時間       | DateTime | 2025/01/15 10:00:00 |
| ユーザー名     | String   | jion                |
| 利用時間(時間) | Number   | 2.0                 |
| 利用時間帯     | String   | 10:00-12:00         |
| ユーザーID     | String   | U1234567890abcdef   |

#### 2.2.2 データ保存仕様

- **保存先**: Google SpreadSheet
- **保存タイミング**: 利用登録時
- **重複処理**: 同一ユーザーの複数回利用は個別記録

### 2.3 月次レポート機能

#### 2.3.1 実行仕様

- **実行タイミング**: 毎月1日（GASトリガー）
- **対象期間**: 前月1日〜月末
- **実行時間**: 午前9時（推奨）

#### 2.3.2 集計仕様

1. 前月の利用記録を取得
2. ユーザーIDごとに利用時間を集計
3. 最新のユーザー名を取得
4. 利用時間で降順ソート
5. 割合を計算

#### 2.3.3 レポート形式

```txt
📊 2025年5月の車利用レポート 📊

🚗 総利用時間: 3.1時間
👥 利用者数: 2名

📈 利用時間ランキング:
1️⃣ 和子さん: 3時間 (97%) 🚗
2️⃣ Jionさん: 0.1時間 (3%) 🛵

✨ 今月も安全運転でお願いします！ ✨
```

#### 2.3.4 絵文字分類

| 利用時間   | 絵文字 |
| ---------- | ------ |
| 30時間以上 | 🚗     |
| 20時間以上 | 🚙     |
| 10時間以上 | 🚐     |
| 10時間未満 | 🛵     |

## 3. 技術仕様

### 3.1 開発環境

- **言語**: TypeScript
- **フレームワーク**: Google Apps Script
- **ビルドツール**: @google/clasp
- **パッケージマネージャー**: pnpm

### 3.2 必要な権限

- **スプレッドシート**: `https://www.googleapis.com/auth/spreadsheets`
- **LINE Messaging API**: アクセストークン
- **GAS実行権限**: ユーザーデプロイ

### 3.3 設定項目

| 項目           | 設定場所             |
| -------------- | -------------------- |
| ACCESS_TOKEN   | スクリプトプロパティ |
| SPREADSHEET_ID | スクリプトプロパティ |
| GROUP_ID       | スクリプトプロパティ |

### 3.4 エラーハンドリング

- **入力値検証**: 数値以外、0.1未満の場合は処理をスキップ
- **API通信エラー**: ログ出力とエラー通知
- **データ取得エラー**: 空データの場合は処理を終了

## 4. 運用仕様

### 4.1 初期設定

1. GASプロジェクトの作成
2. スプレッドシートの作成・共有設定
3. スクリプトプロパティの設定
4. `initializeSpreadsheet()`の実行
5. 月次レポートトリガーの設定

### 4.2 メンテナンス

- **ログ確認**: GASエディタの実行ログで動作状況を確認
- **データバックアップ**: スプレッドシートの定期バックアップ
- **権限更新**: LINE APIトークンの有効期限管理

### 4.3 制限事項

- **実行時間制限**: 6分以内
- **API呼び出し制限**: LINE API制限に準拠
- **データ量制限**: スプレッドシートの行数制限

## 5. セキュリティ

### 5.1 アクセス制御

- LINEグループメンバーのみ利用可能
- スプレッドシートはGASプロジェクトのみアクセス

### 5.2 データ保護

- ユーザーIDは暗号化せず保存（LINE API制限）
- 個人情報の最小化原則に従う

## 6. 今後の拡張案

### 6.1 機能拡張

- 利用時間の上限設定
- 利用予約の競合チェック
- 利用統計の詳細分析

### 6.2 改善案

- リアルタイム利用状況表示
- 利用履歴の検索機能
- 管理者向けダッシュボード
